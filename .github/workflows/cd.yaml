name: cd-deploy

on:
  push:
    branches: [ develop, main ]
  workflow_dispatch:

jobs:
  build-and-push:
    name: Build and Push Docker Image
    runs-on: ubuntu-latest
    outputs:
      image_tag: ${{ steps.meta.outputs.version }}
      image_sha: ${{ steps.prepare.outputs.sha_short }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Prepare tags
        id: prepare
        run: |
          SHA_SHORT=$(echo ${{ github.sha }} | cut -c1-7)
          echo "sha_short=$SHA_SHORT" >> $GITHUB_OUTPUT
          echo "üì¶ Image will be tagged: main-$SHA_SHORT and latest"

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Extract metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: riskplaceangola/backend-core
          tags: |
            type=sha,prefix=main-,format=short
            type=raw,value=latest,enable={{is_default_branch}}

      - name: Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./Dockerfile.prod
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=registry,ref=riskplaceangola/backend-core:buildcache
          cache-to: type=registry,ref=riskplaceangola/backend-core:buildcache,mode=max
          build-args: |
            BUILD_DATE=${{ github.event.head_commit.timestamp }}
            VCS_REF=${{ github.sha }}

      - name: Image tags summary
        run: |
          echo "‚úÖ Image built and pushed:"
          echo "  - riskplaceangola/backend-core:main-${{ steps.prepare.outputs.sha_short }}"
          echo "  - riskplaceangola/backend-core:latest"

  deploy:
    name: Deploy to Server
    needs: build-and-push
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Create .env file from base64 secret
        run: |
          echo "${{ secrets.ENV_PROD_BASE64 }}" | base64 --decode > .env
          
          # Validate .env file format
          if [ ! -s .env ]; then
            echo "‚ùå .env file is empty or invalid"
            exit 1
          fi
          
          # Check for null bytes or corruption
          if ! cat .env | tr -d '\0' | diff -q - .env >/dev/null 2>&1; then
            echo "‚ùå .env file contains null bytes (corrupted)"
            exit 1
          fi
          
          # Verify file has valid environment variables
          VAR_COUNT=$(grep -c "=" .env 2>/dev/null || echo "0")
          if [ "$VAR_COUNT" -lt 10 ]; then
            echo "‚ùå .env file has too few variables ($VAR_COUNT found, expected at least 10)"
            exit 1
          fi
          
          echo "‚úÖ .env file created and validated successfully"
          echo "   Variables found: $VAR_COUNT"

      - name: Copy files to server
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          source: "docker-compose.prod.yml,.env,scripts/deploy.sh"
          target: "~/backend-risk-place"
          strip_components: 0

      - name: Deploy on server
        uses: appleboy/ssh-action@v1.0.3
        env:
          IMAGE_TAG: ${{ needs.build-and-push.outputs.image_sha }}
          REPLICAS: "3"
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          envs: IMAGE_TAG,REPLICAS
          script: |
            cd ~/backend-risk-place
            
            echo "üöÄ Deploying version: main-$IMAGE_TAG with $REPLICAS replicas"
            
            # Make deploy script executable
            chmod +x scripts/deploy.sh
            
            # Run deployment with specific version and replicas (includes .env cleanup)
            ./scripts/deploy.sh "main-$IMAGE_TAG" "$REPLICAS"
            
            # Verify .env was removed by deploy.sh
            if [ -f .env ]; then
              echo "‚ö†Ô∏è  Warning: .env still exists after deploy, removing..."
              rm -f .env
            else
              echo "‚úÖ .env file properly cleaned up"
            fi

      - name: Verify deployment
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          script: |
            # Wait a bit for containers to stabilize
            sleep 15
            
            # First, let's see what containers exist
            echo "All running containers:"
            docker ps --format "table {{.Names}}\t{{.Image}}\t{{.Status}}"
            
            echo ""
            echo "All containers (including stopped):"
            docker ps -a --format "table {{.Names}}\t{{.Image}}\t{{.Status}}"
            
            # Check all backend_core containers (substring match)
            TOTAL=$(docker ps --filter "name=backend_core" --format "{{.Names}}" | wc -l | tr -d ' ')
            HEALTHY=$(docker ps --filter "name=backend_core" --filter "health=healthy" --format "{{.Names}}" | wc -l | tr -d ' ')
            
            echo ""
            echo "üìä Deployment status: $HEALTHY/$TOTAL containers healthy"
            
            # If no containers found, check if deployment failed
            if [ "$TOTAL" -eq 0 ]; then
              echo "‚ùå No backend_core containers found!"
              echo ""
              echo "Checking docker-compose status:"
              cd ~/backend-risk-place
              docker compose -f docker-compose.prod.yml ps || docker-compose -f docker-compose.prod.yml ps
              echo ""
              echo "Checking if docker-compose.prod.yml exists:"
              ls -la docker-compose.prod.yml
              echo ""
              echo "Recent docker events:"
              docker events --since 5m --until 0s | grep backend || echo "No backend events found"
              exit 1
            fi
            
            if [ "$HEALTHY" -ge 3 ]; then
              echo "‚úÖ Deployment successful - $HEALTHY instances running"
              
              # Show status of all containers
              echo ""
              echo "Container status:"
              docker ps --filter "name=backend_core" --format "table {{.Names}}\t{{.Status}}"
              
              # Show logs from first container
              echo ""
              echo "Recent logs (first instance):"
              FIRST=$(docker ps --filter "name=backend_core" --format "{{.Names}}" | head -1)
              docker logs --tail 30 "$FIRST"
              
              exit 0
            else
              echo "‚ùå Deployment verification failed"
              echo "Expected: 3+ healthy containers"
              echo "Got: $HEALTHY healthy, $TOTAL total"
              
              echo ""
              echo "Container details:"
              docker ps -a --filter "name=backend_core" --format "table {{.Names}}\t{{.Status}}"
              
              # Show logs from all containers
              echo ""
              echo "Logs from all containers:"
              docker ps --filter "name=backend_core" --format "{{.Names}}" | while read container; do
                echo "--- $container ---"
                docker logs --tail 50 "$container" 2>&1
              done
              
              exit 1
            fi

      - name: Notification
        if: always()
        run: |
          if [ "${{ job.status }}" == "success" ]; then
            echo "‚úÖ Deployment successful with 3 replicas!"
          else
            echo "‚ùå Deployment failed!"
          fi
